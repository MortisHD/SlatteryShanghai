<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.socket.io;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self' ws: wss:;
        font-src 'self';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <title>Slattery Shanghai - Family Card Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        
        .scoreboard-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            max-width: 300px;
            z-index: 100;
        }
        
        .scoreboard-overlay h4 {
            margin-bottom: 10px;
            text-align: center;
            color: #ffd700;
        }
        
        .scoreboard-overlay table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .scoreboard-overlay th {
            background: rgba(255,255,255,0.1);
            padding: 4px 2px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            font-size: 9px;
        }
        
        .scoreboard-overlay td {
            padding: 4px 2px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .scoreboard-overlay .player-name {
            text-align: left;
            font-weight: bold;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .scoreboard-overlay .total-score {
            font-weight: bold;
            color: #ffd700;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: #ffd700;
        }
        
        .game-setup {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .game-board {
            display: none;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .main-area {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .status {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        input, button {
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
            border: none;
            border-radius: 8px;
        }
        
        input {
            width: 100%;
            color: black;
        }
        
        button {
            background: #4caf50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #ff9800;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #f57c00;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #da190b;
        }
        
        .messages {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
        }
        
        .round-info {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .hand-area {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .cards-container {
            position: relative;
            min-height: 94px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .card {
            width: 60px;
            height: 84px;
            background: white;
            color: black;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .card.selected {
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        
        .card.red {
            color: #d32f2f;
        }
        
        .card.black {
            color: #1976d2;
        }
        
        .piles-area {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .pile {
            width: 80px;
            height: 112px;
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .pile:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .players-list {
            margin: 20px 0;
        }
        
        .player {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .player.current-turn {
            background: rgba(255,215,0,0.3);
            border: 2px solid #ffd700;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .actions button {
            margin: 5px 0;
        }
        
        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: 1fr;
            }
            
            .card {
                width: 45px;
                height: 63px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scoreboard-overlay" id="scoreboardOverlay" style="display: none;">
            <h4>üèÜ Scoreboard</h4>
            <div id="overlayScoresTable">
                <!-- Scores will appear here -->
            </div>
        </div>
        
        <div class="header">
            <h1>Slattery Shanghai</h1>
            <p>Family Card Game - 7 Rounds Edition</p>
        </div>
        
        <div id="gameSetup" class="game-setup">
            <h2>Join Game</h2>
            
            <div class="status" id="connectionStatus">
                Status: Not connected
            </div>
            
            <input type="text" id="playerName" placeholder="Your name" />
            <input type="text" id="gameCode" placeholder="Game code (optional)" />
            
            <button onclick="testSocket()">Connect to Server</button>
            <button id="joinBtn" onclick="joinGame()" disabled>Join Game</button>
            
            <div id="waitingArea" style="display: none; margin-top: 30px;">
                <h3>Waiting for Players...</h3>
                <div class="status" id="gameInfo">
                    Game Code: <span id="displayCode">-</span><br>
                    Players: <span id="playerCount">0</span>
                </div>
                <div id="currentPlayers"></div>
                <button id="startBtn" onclick="startGame()" style="display: none;">Start Game</button>
            </div>
        </div>
        
        <div id="gameBoard" class="game-board">
            <div class="main-area">
                <div class="round-info">
                    <h3>Round <span id="currentRound">1</span> of 7</h3>
                    <div class="status">
                        <strong>Required:</strong> <span id="requiredMelds">2 Sets of 3</span><br>
                        <small id="roundDescription">Two sets of three cards each</small>
                    </div>
                </div>
                
                <div class="piles-area">
                    <div class="pile" onclick="drawCard()" id="drawPile">
                        <div style="color: white; text-align: center;">
                            <div>üÇ†</div>
                            <small>Draw</small>
                        </div>
                    </div>
                    <div class="pile" onclick="pickUpDiscard()" id="discardPile">
                        <div id="discardDisplay" style="text-align: center; color: white;">
                            <div>No Card</div>
                            <small>Pick Up</small>
                        </div>
                    </div>
                </div>
                
                <div class="hand-area">
                    <h4>Your Hand (<span id="handCount">0</span> cards)</h4>
                    <div id="playerHand" class="cards-container">
                        <!-- Cards appear here -->
                    </div>
                </div>
                
                <div class="hand-area">
                    <h4>Your Melds</h4>
                    <div id="playerMelds">
                        <p style="color: rgba(255,255,255,0.6);">No melds yet</p>
                    </div>
                </div>
                
                <div class="actions">
                    <button onclick="makeSet()" id="setBtn">Make Set</button>
                    <button onclick="makeRun()" id="runBtn">Make Run</button>
                    <button class="btn-danger" onclick="discardCard()" id="discardBtn">Discard</button>
                    <button class="btn-secondary" onclick="buyCard()" id="buyBtn">Buy (<span id="buysLeft">3</span>)</button>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="players-list">
                    <h4>Players</h4>
                    <div id="playersList">
                        <!-- Players appear here -->
                    </div>
                </div>
                
                <div class="messages" id="messages">
                    <!-- Game messages appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" 
            integrity="sha384-mZLF4UVrpi/QTWPA7BjNPEnkIfRFn9ZAC2pirBdwokM3H8tOO5P8Mv+3RJZj6n8N" 
            crossorigin="anonymous"></script>
    <script>
        console.log("Slattery Shanghai loading...");
        
        // Input sanitization function
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Safe DOM manipulation
        function safeSetText(element, text) {
            if (element) {
                element.textContent = text || '';
            }
        }
        
        // Input validation functions
        function validatePlayerName(name) {
            if (!name || typeof name !== 'string') return false;
            if (name.length < 1 || name.length > 20) return false;
            if (!/^[a-zA-Z0-9\s\-_]+$/.test(name)) return false;
            return name.trim();
        }
        
        function validateGameCode(code) {
            if (!code) return ''; // Optional
            if (typeof code !== 'string') return false;
            if (code.length > 10) return false;
            if (!/^[A-Z0-9]+$/.test(code)) return false;
            return code.trim().toUpperCase();
        }
        
        // Validate server responses
        function validateServerData(data, expectedFields = []) {
            if (!data || typeof data !== 'object') return false;
            
            // Check for required fields
            for (const field of expectedFields) {
                if (!(field in data)) {
                    console.warn(`Missing required field: ${field}`);
                    return false;
                }
            }
            
            return true;
        }
        
        // Game state
        let gameState = {
            myName: '',
            gameCode: '',
            players: [],
            currentPlayer: '',
            round: 1,
            hand: [],
            melds: [],
            buysRemaining: 3,
            selectedCards: [],
            discardTop: null,
            isMyTurn: false,
            hasDrawn: false,
            scores: {},
            roundRequirements: null
        };
        
        let socket = null;
        
        function addMessage(text) {
            const messages = document.getElementById('messages');
            if (messages) {
                const div = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                safeSetText(div, `${timestamp}: ${text}`);
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }
            console.log("Message: " + text);
        }
        
        function testSocket() {
            addMessage("Connecting to server...");
            
            if (socket) {
                socket.disconnect();
            }
            
            try {
                socket = io({
                    transports: ['websocket', 'polling'],
                    timeout: 5000,
                    forceNew: true,
                    autoConnect: true,
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000
                });
                
                socket.on('connect', () => {
                    addMessage("‚úÖ Connected to server!");
                    safeSetText(document.getElementById('connectionStatus'), "Status: Connected");
                    const joinBtn = document.getElementById('joinBtn');
                    if (joinBtn) joinBtn.disabled = false;
                });
                
                socket.on('disconnect', () => {
                    addMessage("‚ùå Disconnected from server");
                    safeSetText(document.getElementById('connectionStatus'), "Status: Disconnected");
                    const joinBtn = document.getElementById('joinBtn');
                    if (joinBtn) joinBtn.disabled = true;
                });
                
                socket.on('playerJoined', (data) => {
                    if (!validateServerData(data, ['gameCode', 'players'])) {
                        addMessage("‚ùå Invalid server response");
                        return;
                    }
                    
                    addMessage("Player joined event received");
                    gameState.gameCode = sanitizeHTML(data.gameCode);
                    gameState.players = data.players.map(p => sanitizeHTML(p));
                    
                    safeSetText(document.getElementById('displayCode'), gameState.gameCode);
                    safeSetText(document.getElementById('playerCount'), gameState.players.length.toString());
                    
                    // Show players safely
                    const playersDiv = document.getElementById('currentPlayers');
                    if (playersDiv) {
                        playersDiv.innerHTML = '';
                        const header = document.createElement('h4');
                        safeSetText(header, 'Current Players:');
                        playersDiv.appendChild(header);
                        
                        gameState.players.forEach(player => {
                            const div = document.createElement('div');
                            div.className = 'player';
                            const span = document.createElement('span');
                            safeSetText(span, player);
                            div.appendChild(span);
                            playersDiv.appendChild(div);
                        });
                    }
                    
                    const waitingArea = document.getElementById('waitingArea');
                    if (waitingArea) waitingArea.style.display = 'block';
                    
                    if (data.isHost) {
                        const startBtn = document.getElementById('startBtn');
                        if (startBtn) startBtn.style.display = 'block';
                        addMessage("You are the host! Click Start Game when ready.");
                    }
                });
                
                socket.on('gameStarted', (data) => {
                    if (!validateServerData(data)) {
                        addMessage("‚ùå Invalid game start data");
                        return;
                    }
                    
                    addMessage("üéÆ Game started!");
                    updateGameState(data);
                    showGameBoard();
                });
                
                socket.on('gameUpdate', (data) => {
                    if (!validateServerData(data)) {
                        addMessage("‚ùå Invalid game update data");
                        return;
                    }
                    
                    console.log("üîÑ GAME UPDATE RECEIVED:", data);
                    updateGameState(data);
                    updateGameUI();
                    
                    if (data.hand && data.hand.length < gameState.hand.length) {
                        gameState.selectedCards = [];
                    }
                    
                    addMessage("Game state updated");
                });
                
                socket.on('gameMessage', (data) => {
                    if (data && data.message) {
                        addMessage(sanitizeHTML(data.message));
                    }
                });
                
                socket.on('gameComplete', (data) => {
                    if (!validateServerData(data)) {
                        addMessage("‚ùå Invalid game completion data");
                        return;
                    }
                    
                    console.log("üèÜ GAME COMPLETE EVENT RECEIVED:", data);
                    showFinalResults(data);
                    addMessage(`üèÜ GAME COMPLETE! Winner: ${sanitizeHTML(data.winner)} with ${data.winnerScore} points!`);
                });
                
                socket.on('error', (data) => {
                    console.error("üö® Socket error received:", data);
                    if (data && data.message) {
                        addMessage("‚ùå Error: " + sanitizeHTML(data.message));
                    }
                });
                
            } catch (error) {
                addMessage("‚ùå Connection failed: " + error.message);
            }
        }
        
        function joinGame() {
            const playerNameInput = document.getElementById('playerName');
            const gameCodeInput = document.getElementById('gameCode');
            
            if (!playerNameInput || !gameCodeInput) {
                addMessage("‚ùå Form elements not found");
                return;
            }
            
            const playerName = validatePlayerName(playerNameInput.value);
            const gameCode = validateGameCode(gameCodeInput.value);
            
            if (!playerName) {
                addMessage("‚ùå Invalid player name. Use only letters, numbers, spaces, hyphens, and underscores (1-20 characters)");
                return;
            }
            
            if (gameCode === false) {
                addMessage("‚ùå Invalid game code format");
                return;
            }
            
            if (!socket || !socket.connected) {
                addMessage("‚ùå Please connect to server first");
                return;
            }
            
            gameState.myName = playerName;
            addMessage("Joining game as " + playerName + "...");
            
            socket.emit('joinGame', {
                playerName: playerName,
                gameCode: gameCode
            });
        }
        
        function startGame() {
            if (!socket) return;
            
            addMessage("Starting game...");
            socket.emit('startGame');
        }
        
        function updateGameState(data) {
            console.log("Updating game state with:", data);
            
            // Safely update game state with validation
            gameState.gameCode = sanitizeHTML(data.gameCode) || gameState.gameCode;
            gameState.players = Array.isArray(data.players) ? data.players.map(p => sanitizeHTML(p)) : gameState.players;
            gameState.currentPlayer = sanitizeHTML(data.currentPlayer) || gameState.currentPlayer;
            gameState.round = Number.isInteger(data.currentRound) ? data.currentRound : gameState.round;
            gameState.hand = Array.isArray(data.hand) ? data.hand : [];
            gameState.melds = Array.isArray(data.melds) ? data.melds : [];
            gameState.buysRemaining = Number.isInteger(data.buysRemaining) ? data.buysRemaining : 0;
            gameState.discardTop = data.discardTop || null;
            gameState.isMyTurn = data.currentPlayer === gameState.myName;
            gameState.hasDrawn = data.turnState ? Boolean(data.turnState.hasDrawn) : false;
            gameState.scores = (data.scores && typeof data.scores === 'object') ? data.scores : {};
            
            if (data.roundRequirements && typeof data.roundRequirements === 'object') {
                gameState.roundRequirements = data.roundRequirements;
            }
        }
        
        function showGameBoard() {
            const gameSetup = document.getElementById('gameSetup');
            const gameBoard = document.getElementById('gameBoard');
            const scoreboardOverlay = document.getElementById('scoreboardOverlay');
            
            if (gameSetup) gameSetup.style.display = 'none';
            if (gameBoard) gameBoard.style.display = 'grid';
            if (scoreboardOverlay) scoreboardOverlay.style.display = 'block';
            
            updateGameUI();
        }
        
        function updateGameUI() {
            console.log("=== UPDATING GAME UI ===");
            
            try {
                // Update round info safely
                safeSetText(document.getElementById('currentRound'), gameState.round.toString());
                safeSetText(document.getElementById('buysLeft'), gameState.buysRemaining.toString());
                
                if (gameState.roundRequirements) {
                    safeSetText(document.getElementById('requiredMelds'), gameState.roundRequirements.melds);
                    safeSetText(document.getElementById('roundDescription'), gameState.roundRequirements.description);
                }
                
                updateHand();
                updatePlayers();
                updateDiscardPile();
                updateMelds();
                updateButtons();
                updateOverlayScoreboard();
                
                console.log("=== GAME UI UPDATE COMPLETE ===");
            } catch (error) {
                console.error("Error in updateGameUI:", error);
                addMessage("Display update error: " + error.message);
            }
        }
        
        function updateHand() {
            console.log("Updating hand with", gameState.hand.length, "cards");
            
            const handDiv = document.getElementById('playerHand');
            const handCount = document.getElementById('handCount');
            
            if (!handDiv || !handCount) return;
            
            handDiv.innerHTML = '';
            safeSetText(handCount, gameState.hand.length.toString());
            
            gameState.hand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = `card ${card.color}`;
                cardDiv.dataset.index = index;
                
                if (gameState.selectedCards.includes(index)) {
                    cardDiv.classList.add('selected');
                }
                
                // Safely create card content
                const topDisplay = document.createElement('div');
                safeSetText(topDisplay, card.display);
                
                const bottomDisplay = document.createElement('div');
                bottomDisplay.style.transform = 'rotate(180deg)';
                safeSetText(bottomDisplay, card.display);
                
                cardDiv.appendChild(topDisplay);
                cardDiv.appendChild(bottomDisplay);
                
                cardDiv.onclick = () => toggleCardSelection(index);
                
                handDiv.appendChild(cardDiv);
            });
        }
        
        function updatePlayers() {
            const playersDiv = document.getElementById('playersList');
            if (!playersDiv) return;
            
            playersDiv.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player';
                
                if (player === gameState.currentPlayer) {
                    playerDiv.classList.add('current-turn');
                }
                
                // Safely create player display
                const playerInfo = document.createElement('div');
                const playerName = document.createElement('span');
                playerName.style.fontWeight = 'bold';
                safeSetText(playerName, player + (player === gameState.currentPlayer ? ' üëë' : ''));
                
                playerInfo.appendChild(playerName);
                
                const playerStatus = document.createElement('div');
                playerStatus.style.textAlign = 'right';
                safeSetText(playerStatus, player === gameState.myName ? '(You)' : '');
                
                playerDiv.appendChild(playerInfo);
                playerDiv.appendChild(playerStatus);
                playersDiv.appendChild(playerDiv);
            });
        }
        
        function updateDiscardPile() {
            const discardDiv = document.getElementById('discardDisplay');
            if (!discardDiv) return;
            
            discardDiv.innerHTML = '';
            
            if (gameState.discardTop) {
                const cardDisplay = document.createElement('div');
                cardDisplay.style.cssText = `
                    background: white; 
                    color: ${gameState.discardTop.color === 'red' ? '#d32f2f' : '#1976d2'}; 
                    padding: 8px; 
                    border-radius: 6px; 
                    font-weight: bold;
                    border: 2px solid #333;
                    min-height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                safeSetText(cardDisplay, gameState.discardTop.display);
                
                const label = document.createElement('small');
                label.style.marginTop = '5px';
                label.style.display = 'block';
                safeSetText(label, 'Pick Up');
                
                discardDiv.appendChild(cardDisplay);
                discardDiv.appendChild(label);
            } else {
                const noCard = document.createElement('div');
                noCard.style.color = 'white';
                safeSetText(noCard, 'No Card');
                
                const label = document.createElement('small');
                safeSetText(label, 'Pick Up');
                
                discardDiv.appendChild(noCard);
                discardDiv.appendChild(label);
            }
        }
        
        function updateMelds() {
            const meldsDiv = document.getElementById('playerMelds');
            if (!meldsDiv) return;
            
            if (gameState.melds.length === 0) {
                meldsDiv.innerHTML = '';
                const noMelds = document.createElement('p');
                noMelds.style.color = 'rgba(255,255,255,0.6)';
                safeSetText(noMelds, 'No melds yet');
                meldsDiv.appendChild(noMelds);
                return;
            }
            
            meldsDiv.innerHTML = '';
            gameState.melds.forEach((meld) => {
                const meldDiv = document.createElement('div');
                meldDiv.style.margin = '10px 0';
                meldDiv.style.padding = '10px';
                meldDiv.style.background = 'rgba(255,255,255,0.1)';
                meldDiv.style.borderRadius = '8px';
                
                const meldType = document.createElement('strong');
                safeSetText(meldType, meld.type.toUpperCase() + ': ');
                meldDiv.appendChild(meldType);
                
                meld.cards.forEach(card => {
                    const cardSpan = document.createElement('span');
                    cardSpan.style.color = card.color === 'red' ? '#d32f2f' : '#1976d2';
                    cardSpan.style.marginRight = '5px';
                    safeSetText(cardSpan, card.display);
                    meldDiv.appendChild(cardSpan);
                });
                
                meldsDiv.appendChild(meldDiv);
            });
        }
        
        function updateButtons() {
            const isMyTurn = gameState.isMyTurn;
            const hasDrawn = gameState.hasDrawn;
            const hasSelected = gameState.selectedCards.length > 0;
            const canBuy = gameState.buysRemaining > 0 && !isMyTurn && gameState.discardTop;
            
            const setBtn = document.getElementById('setBtn');
            const runBtn = document.getElementById('runBtn');
            const discardBtn = document.getElementById('discardBtn');
            const buyBtn = document.getElementById('buyBtn');
            
            if (setBtn) {
                setBtn.disabled = !isMyTurn || !hasSelected || gameState.selectedCards.length < 3;
                setBtn.title = !isMyTurn ? "Not your turn" : 
                             !hasSelected ? "Select cards first" :
                             gameState.selectedCards.length < 3 ? "Need at least 3 cards for a set" : 
                             "Make a set with selected cards";
            }
            
            if (runBtn) {
                runBtn.disabled = !isMyTurn || !hasSelected || gameState.selectedCards.length < 4;
                runBtn.title = !isMyTurn ? "Not your turn" : 
                              !hasSelected ? "Select cards first" :
                              gameState.selectedCards.length < 4 ? "Need at least 4 cards for a run" : 
                              "Make a run with selected cards";
            }
            
            if (discardBtn) {
                const canDiscard = isMyTurn && hasDrawn && gameState.selectedCards.length === 1;
                discardBtn.disabled = !canDiscard;
                discardBtn.title = !isMyTurn ? "Not your turn" : 
                                  !hasDrawn ? "Draw a card first" :
                                  gameState.selectedCards.length !== 1 ? "Select exactly one card to discard" :
                                  "Discard selected card";
            }
            
            if (buyBtn) {
                buyBtn.disabled = !canBuy;
                buyBtn.title = gameState.isMyTurn ? "Cannot buy on your turn" :
                              gameState.buysRemaining <= 0 ? "No buys remaining" :
                              !gameState.discardTop ? "No card to buy" :
                              "Buy the top discard card";
            }
        }
        
        function updateOverlayScoreboard() {
            const scoresDiv = document.getElementById('overlayScoresTable');
            if (!scoresDiv) return;
            
            scoresDiv.innerHTML = '';
            
            if (Object.keys(gameState.scores).length === 0) {
                const noScores = document.createElement('p');
                noScores.style.textAlign = 'center';
                noScores.style.color = 'rgba(255,255,255,0.6)';
                safeSetText(noScores, 'No scores yet');
                scoresDiv.appendChild(noScores);
                return;
            }
            
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            
            const playerHeader = document.createElement('th');
            safeSetText(playerHeader, 'Player');
            headerRow.appendChild(playerHeader);
            
            for (let i = 1; i <= 7; i++) {
                const roundHeader = document.createElement('th');
                safeSetText(roundHeader, `R${i}`);
                headerRow.appendChild(roundHeader);
            }
            
            const totalHeader = document.createElement('th');
            safeSetText(totalHeader, 'Total');
            headerRow.appendChild(totalHeader);
            table.appendChild(headerRow);
            
            gameState.players.forEach(player => {
                const playerScores = gameState.scores[player] || Array(7).fill(0);
                const total = playerScores.reduce((sum, score) => sum + (score || 0), 0);
                
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.className = 'player-name';
                safeSetText(nameCell, sanitizeHTML(player));
                row.appendChild(nameCell);
                
                playerScores.forEach(score => {
                    const scoreCell = document.createElement('td');
                    safeSetText(scoreCell, score || '-');
                    row.appendChild(scoreCell);
                });
                
                const totalCell = document.createElement('td');
                totalCell.className = 'total-score';
                safeSetText(totalCell, total.toString());
                row.appendChild(totalCell);
                
                table.appendChild(row);
            });
            
            scoresDiv.appendChild(table);
        }
        
        function showFinalResults(results) {
            if (!validateServerData(results, ['winner', 'winnerScore', 'finalStandings'])) {
                addMessage("‚ùå Invalid final results data");
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'finalResultsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                padding: 30px;
                border-radius: 15px;
                border: 3px solid #ffd700;
                max-width: 600px;
                color: white;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            // Create content safely
            const title = document.createElement('h1');
            title.style.cssText = 'color: #ffd700; margin-bottom: 20px;';
            safeSetText(title, 'üèÜ GAME COMPLETE! üèÜ');
            modalContent.appendChild(title);
            
            const winner = document.createElement('h2');
            winner.style.marginBottom = '30px';
            safeSetText(winner, `Winner: ${sanitizeHTML(results.winner)}`);
            modalContent.appendChild(winner);
            
            const score = document.createElement('p');
            score.style.cssText = 'font-size: 18px; margin-bottom: 30px;';
            safeSetText(score, `Final Score: ${results.winnerScore} points`);
            modalContent.appendChild(score);
            
            const standingsTitle = document.createElement('h3');
            standingsTitle.style.cssText = 'margin-bottom: 20px; color: #ffd700;';
            safeSetText(standingsTitle, 'Final Standings:');
            modalContent.appendChild(standingsTitle);
            
            const standingsDiv = document.createElement('div');
            standingsDiv.style.cssText = 'background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-bottom: 30px;';
            
            if (Array.isArray(results.finalStandings)) {
                results.finalStandings.forEach((player, index) => {
                    const [playerName, playerScore] = player;
                    const stats = results.playerStats && results.playerStats[playerName];
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                    
                    const standingDiv = document.createElement('div');
                    standingDiv.style.cssText = `
                        display: flex; 
                        justify-content: space-between; 
                        align-items: center; 
                        padding: 10px; 
                        background: ${index === 0 ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)'}; 
                        margin: 5px 0; 
                        border-radius: 5px;
                    `;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.style.fontWeight = 'bold';
                    safeSetText(nameSpan, `${medal} ${sanitizeHTML(playerName)}`);
                    
                    const scoreSpan = document.createElement('span');
                    const roundsWon = stats ? stats.roundsWon : 0;
                    safeSetText(scoreSpan, `${playerScore} points (${roundsWon} rounds won)`);
                    
                    standingDiv.appendChild(nameSpan);
                    standingDiv.appendChild(scoreSpan);
                    standingsDiv.appendChild(standingDiv);
                });
            }
            
            modalContent.appendChild(standingsDiv);
            
            const closeBtn = document.createElement('button');
            closeBtn.style.cssText = 'background: #ff9800; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px;';
            safeSetText(closeBtn, 'Close');
            closeBtn.onclick = closeFinalResults;
            modalContent.appendChild(closeBtn);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        function closeFinalResults() {
            const modal = document.getElementById('finalResultsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function toggleCardSelection(index) {
            // Validate index
            if (!Number.isInteger(index) || index < 0 || index >= gameState.hand.length) {
                return;
            }
            
            const selectedIndex = gameState.selectedCards.indexOf(index);
            if (selectedIndex > -1) {
                gameState.selectedCards.splice(selectedIndex, 1);
            } else {
                gameState.selectedCards.push(index);
            }
            updateHand();
            updateButtons();
        }
        
        function drawCard() {
            if (!gameState.isMyTurn || gameState.hasDrawn) {
                addMessage("‚ùå Not your turn or already drawn");
                return;
            }
            
            addMessage("Drawing from deck...");
            socket.emit('drawCard');
        }
        
        function pickUpDiscard() {
            if (!gameState.isMyTurn || gameState.hasDrawn) {
                addMessage("‚ùå Not your turn or already drawn");
                return;
            }
            
            if (!gameState.discardTop) {
                addMessage("‚ùå No card in discard pile");
                return;
            }
            
            addMessage("Picking up from discard pile...");
            socket.emit('pickUpDiscard');
        }
        
        function buyCard() {
            if (gameState.isMyTurn || gameState.buysRemaining <= 0) {
                addMessage("‚ùå Cannot buy on your turn or no buys left");
                return;
            }
            
            if (!gameState.discardTop) {
                addMessage("‚ùå No card to buy");
                return;
            }
            
            addMessage("Buying card...");
            socket.emit('buyCard');
        }
        
        function makeSet() {
            if (!gameState.isMyTurn || gameState.selectedCards.length < 3) {
                addMessage("‚ùå Select at least 3 cards to make a set");
                return;
            }
            
            // Validate selected card indices
            if (!gameState.selectedCards.every(index => 
                Number.isInteger(index) && index >= 0 && index < gameState.hand.length)) {
                addMessage("‚ùå Invalid card selection");
                return;
            }
            
            addMessage(`Attempting to make set with ${gameState.selectedCards.length} cards...`);
            
            socket.emit('makeMeld', {
                cardIndices: gameState.selectedCards,
                meldType: 'set'
            });
        }
        
        function makeRun() {
            if (!gameState.isMyTurn || gameState.selectedCards.length < 4) {
                addMessage("‚ùå Select at least 4 cards to make a run");
                return;
            }
            
            // Validate selected card indices
            if (!gameState.selectedCards.every(index => 
                Number.isInteger(index) && index >= 0 && index < gameState.hand.length)) {
                addMessage("‚ùå Invalid card selection");
                return;
            }
            
            addMessage(`Attempting to make run with ${gameState.selectedCards.length} cards...`);
            
            socket.emit('makeMeld', {
                cardIndices: gameState.selectedCards,
                meldType: 'run'
            });
        }
        
        function discardCard() {
            if (!gameState.isMyTurn || !gameState.hasDrawn || gameState.selectedCards.length !== 1) {
                addMessage("‚ùå Select exactly one card to discard after drawing");
                return;
            }
            
            const cardIndex = gameState.selectedCards[0];
            
            // Validate the card index
            if (!Number.isInteger(cardIndex) || cardIndex < 0 || cardIndex >= gameState.hand.length) {
                addMessage("‚ùå Invalid card selection");
                return;
            }
            
            socket.emit('discardCard', {
                cardIndex: cardIndex
            });
            
            gameState.selectedCards = [];
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            addMessage('Welcome to Slattery Shanghai!');
            addMessage('Click "Connect to Server" first, then join the game.');
            
            // Add security event listeners
            window.addEventListener('error', function(e) {
                console.error('Client error:', e.error);
                addMessage('‚ö†Ô∏è An error occurred. Please refresh if problems persist.');
            });
            
            // Prevent common XSS vectors
            document.addEventListener('paste', function(e) {
                // Don't prevent paste entirely, but log suspicious activity
                const pastedData = e.clipboardData.getData('text');
                if (pastedData.includes('<script') || pastedData.includes('javascript:')) {
                    console.warn('Suspicious paste content detected');
                }
            });
        });
        
        // Add additional security measures
        (function() {
            // Prevent console manipulation in production
            if (window.location.protocol === 'https:') {
                console.log('üîí Security mode enabled');
                
                // Clear console periodically in production
                setInterval(() => {
                    if (typeof console.clear === 'function') {
                        console.clear();
                    }
                }, 30000);
            }
            
            // Monitor for suspicious activity
            let suspiciousActivity = 0;
            
            document.addEventListener('keydown', function(e) {
                // Detect potential developer tools usage
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                    (e.ctrlKey && e.shiftKey && e.key === 'C')) {
                    suspiciousActivity++;
                    if (suspiciousActivity > 5) {
                        console.warn('Multiple attempts to access developer tools detected');
                    }
                }
            });
        })();
    </script>
</body>
</html>
