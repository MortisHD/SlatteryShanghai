<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.socket.io;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self' ws: wss:;
        font-src 'self';
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <title>Slattery Shanghai - Family Card Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        
        .scoreboard-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            max-width: 300px;
            z-index: 100;
        }
        
        .scoreboard-overlay h4 {
            margin-bottom: 10px;
            text-align: center;
            color: #ffd700;
        }
        
        .scoreboard-overlay table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        .scoreboard-overlay th {
            background: rgba(255,255,255,0.1);
            padding: 4px 2px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            font-size: 9px;
        }
        
        .scoreboard-overlay td {
            padding: 4px 2px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .scoreboard-overlay .player-name {
            text-align: left;
            font-weight: bold;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .scoreboard-overlay .total-score {
            font-weight: bold;
            color: #ffd700;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .slattery-crest {
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .crest-image {
            width: 80px;
            height: auto;
            max-height: 95px;
            object-fit: contain;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            background: rgba(255,255,255,0.9);
            padding: 3px;
        }
        
        .crest-image:hover {
            transform: scale(1.05);
            transition: transform 0.3s ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: #ffd700;
        }
        
        .game-setup {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .game-board {
            display: none;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .main-area {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .status {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        input, button {
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
            border: none;
            border-radius: 8px;
        }
        
        input {
            width: 100%;
            color: black;
        }
        
        button {
            background: #4caf50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #ff9800;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #f57c00;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #da190b;
        }
        
        .btn-organization {
            background: #9c27b0;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .btn-organization:hover:not(:disabled) {
            background: #7b1fa2;
            transform: translateY(-1px);
        }
        
        .messages {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
        }
        
        .round-info {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .hand-area {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .cards-container {
            position: relative;
            min-height: 94px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .insertion-point {
            width: 8px;
            height: 84px;
            background: transparent;
            border: 2px dashed transparent;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .card {
            width: 60px;
            height: 84px;
            background: white;
            color: black;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .card:hover:not(.dragging) {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .card.selected {
            position: relative;
        }
        
        .card.selected::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #ffd700;
            border-radius: 8px;
            pointer-events: none;
            animation: selectedPulse 1.5s infinite;
        }
        
        @keyframes selectedPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .card.dragging {
            opacity: 0.6;
            transform: rotate(3deg) scale(1.05);
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        
        .card.red {
            color: #d32f2f;
        }
        
        .card.black {
            color: #1976d2;
        }
        
        .all-melds-area {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-melds-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }
        
        .player-melds-section.current-player {
            border-left-color: #ffd700;
            background: rgba(255,215,0,0.1);
        }
        
        .player-melds-section.my-melds {
            border-left-color: #2196f3;
            background: rgba(33,150,243,0.1);
        }
        
        .player-melds-section.can-go-out {
            border-left-color: #ff5722;
            background: rgba(255,87,34,0.1);
            animation: pulse 2s infinite;
        }
        
        .player-melds-section.close-to-winning {
            background: linear-gradient(45deg, rgba(255,152,0,0.1), rgba(245,124,0,0.1)) !important;
            border-left-color: #ff9800 !important;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,87,34,0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255,87,34,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,87,34,0); }
        }
        
        .player-melds-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .player-melds-header h5 {
            margin: 0;
            color: #ffd700;
            font-size: 16px;
        }
        
        .hand-count-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }
        
        .requirements-met-badge {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .meld-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .meld-type-label {
            font-weight: bold;
            color: #4caf50;
            margin-right: 10px;
            text-transform: uppercase;
            font-size: 12px;
        }
        
        .meld-card {
            background: white;
            color: black;
            padding: 4px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
            min-width: 24px;
            text-align: center;
            border: 1px solid #333;
        }
        
        .meld-card.red {
            color: #d32f2f;
        }
        
        .meld-card.black {
            color: #1976d2;
        }
        
        .no-melds-message {
            color: rgba(255,255,255,0.5);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        .melds-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .melds-toggle:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .melds-collapsed .meld-display {
            display: none;
        }
        
        .quick-reference {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .quick-reference h4 {
            margin: 0 0 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            cursor: pointer;
        }
        
        .quick-ref-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .quick-ref-collapsed .quick-ref-content {
            max-height: 0;
            padding: 0;
            margin: 0;
        }
        
        .ref-section {
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        
        .ref-section h5 {
            margin: 0 0 6px 0;
            color: #ffd700;
            font-size: 12px;
        }
        
        .ref-section p {
            margin: 0;
            font-size: 11px;
            color: white;
        }
        
        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
            font-size: 11px;
        }
        
        .alert-box {
            min-height: 20px;
            font-size: 11px;
            color: #ff9800;
        }
        
        .danger-alert {
            color: #f44336 !important;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        .piles-area {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .pile {
            width: 80px;
            height: 112px;
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .pile:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .players-list {
            margin: 20px 0;
        }
        
        .player {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .player.current-turn {
            background: rgba(255,215,0,0.3);
            border: 2px solid #ffd700;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .actions button {
            margin: 5px 0;
        }
        
        .card-organization {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: 1fr;
            }
            
            .card {
                width: 45px;
                height: 63px;
                font-size: 10px;
            }
            
            .insertion-point {
                width: 6px !important;
                height: 63px;
            }
            
            .cards-container {
                min-height: 73px;
            }
            
            .btn-organization {
                padding: 6px 8px;
                font-size: 10px;
                margin: 1px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scoreboard-overlay" id="scoreboardOverlay" style="display: none;">
            <h4>🏆 Scoreboard</h4>
            <div id="overlayScoresTable">
                <!-- Scores will appear here -->
            </div>
        </div>
        
        <div class="header">
            <div class="slattery-crest">
                <img src="slattery-crest.jpg" alt="Slattery Family Crest" class="crest-image">
            </div>
            <h1>Slattery Shanghai</h1>
            <p>Family Card Game - 7 Rounds Edition</p>
        </div>
        
        <div id="gameSetup" class="game-setup">
            <h2>Join Game</h2>
            
            <div class="status" id="connectionStatus">
                Status: Not connected
            </div>
            
            <input type="text" id="playerName" placeholder="Your name" />
            <input type="text" id="gameCode" placeholder="Game code (optional)" />
            
            <button onclick="testSocket()">Connect to Server</button>
            <button id="joinBtn" onclick="joinGame()" disabled>Join Game</button>
            
            <div id="waitingArea" style="display: none; margin-top: 30px;">
                <h3>Waiting for Players...</h3>
                <div class="status" id="gameInfo">
                    Game Code: <span id="displayCode">-</span><br>
                    Players: <span id="playerCount">0</span>
                </div>
                <div id="currentPlayers"></div>
                <button id="startBtn" onclick="startGame()" style="display: none;">Start Game</button>
            </div>
        </div>
        
        <div id="gameBoard" class="game-board">
            <div class="main-area">
                <div class="round-info">
                    <h3>Round <span id="currentRound">1</span> of 7</h3>
                    <div class="status">
                        <strong>Required:</strong> <span id="requiredMelds">2 Sets of 3</span><br>
                        <small id="roundDescription">Two sets of three cards each</small>
                    </div>
                </div>
                
                <div class="piles-area">
                    <div class="pile" onclick="drawCard()" id="drawPile">
                        <div style="color: white; text-align: center;">
                            <div>🂠</div>
                            <small>Draw</small>
                        </div>
                    </div>
                    <div class="pile" onclick="pickUpDiscard()" id="discardPile">
                        <div id="discardDisplay" style="text-align: center; color: white;">
                            <div>No Card</div>
                            <small>Pick Up</small>
                        </div>
                    </div>
                </div>
                
                <div class="all-melds-area">
                    <h4>🃏 Players' Melds on Table</h4>
                    <div id="allPlayerMelds">
                        <p class="no-melds-message">No melds on the table yet</p>
                    </div>
                </div>
                
                <div class="hand-area">
                    <h4>Your Hand (<span id="handCount">0</span> cards)</h4>
                    <div id="playerHand" class="cards">
                        <!-- Cards appear here -->
                    </div>
                </div>
                
                <div class="hand-area">
                    <h4>Your Melds</h4>
                    <div id="playerMelds">
                        <p style="color: rgba(255,255,255,0.6);">No melds yet</p>
                    </div>
                </div>
                
                <div class="actions">
                    <button onclick="makeSet()" id="setBtn">Make Set</button>
                    <button onclick="makeRun()" id="runBtn">Make Run</button>
                    <button class="btn-danger" onclick="discardCard()" id="discardBtn">Discard</button>
                    <button class="btn-secondary" onclick="buyCard()" id="buyBtn">Buy (<span id="buysLeft">3</span>)</button>
                    
                    <div class="card-organization">
                        <small style="color: rgba(255,255,255,0.7); display: block; margin-bottom: 5px;">Card Organization:</small>
                        <button class="btn-organization" onclick="autoSortBySuit()" title="Sort cards by suit, then rank">
                            🃏 Sort by Suit
                        </button>
                        <button class="btn-organization" onclick="autoSortByRank()" title="Sort cards by rank, then suit">
                            🔢 Sort by Rank
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="players-list">
                    <h4>Players</h4>
                    <div id="playersList">
                        <!-- Players appear here -->
                    </div>
                </div>
                
                <div class="quick-reference" id="quickReference">
                    <h4 style="cursor: pointer;" onclick="toggleQuickReference()">
                        📋 Quick Reference <span id="refToggle">▼</span>
                    </h4>
                    <div id="quickRefContent" class="quick-ref-content">
                        <div class="ref-section">
                            <h5>Current Round Goal:</h5>
                            <p id="currentGoal">2 Sets of 3</p>
                        </div>
                        <div class="ref-section">
                            <h5>Progress Check:</h5>
                            <div id="progressIndicator">
                                <div class="progress-item">
                                    <span>Requirements Met:</span>
                                    <span id="reqMet">❌</span>
                                </div>
                                <div class="progress-item">
                                    <span>Can Go Out:</span>
                                    <span id="canGoOut">❌</span>
                                </div>
                            </div>
                        </div>
                        <div class="ref-section">
                            <h5>Next Player Alert:</h5>
                            <div id="nextPlayerAlert" class="alert-box">
                                <!-- Warnings about players close to winning -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="messages" id="messages">
                    <!-- Game messages appear here -->
                </div>
                
                <div id="scoresTable">
                    <!-- Scores will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" 
            integrity="sha384-mZLF4UVrpi/QTWPA7BjNPEnkIfRFn9ZAC2pirBdwokM3H8tOO5P8Mv+3RJZj6n8N" 
            crossorigin="anonymous"></script>
    <script>
        console.log("Slattery Shanghai loading...");
        
        // Input sanitization function
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Safe DOM manipulation
        function safeSetText(element, text) {
            if (element) {
                element.textContent = text || '';
            }
        }
        
        // Input validation functions
        function validatePlayerName(name) {
            if (!name || typeof name !== 'string') return false;
            if (name.length < 1 || name.length > 20) return false;
            if (!/^[a-zA-Z0-9\s\-_]+$/.test(name)) return false;
            return name.trim();
        }
        
        function validateGameCode(code) {
            if (!code) return ''; // Optional
            if (typeof code !== 'string') return false;
            if (code.length > 10) return false;
            if (!/^[A-Z0-9]+$/.test(code)) return false;
            return code.trim().toUpperCase();
        }
        
        // Validate server responses
        function validateServerData(data, expectedFields = []) {
            if (!data || typeof data !== 'object') return false;
            
            // Check for required fields
            for (const field of expectedFields) {
                if (!(field in data)) {
                    console.warn(`Missing required field: ${field}`);
                    return false;
                }
            }
            
            return true;
        }
        
        // Game state
        let gameState = {
            myName: '',
            gameCode: '',
            players: [],
            currentPlayer: '',
            round: 1,
            hand: [],
            melds: [],
            allPlayerMelds: {},
            handCounts: {},
            buysRemaining: 3,
            selectedCards: [],
            discardTop: null,
            isMyTurn: false,
            hasDrawn: false,
            scores: {},
            roundRequirements: null
        };
        
        let socket = null;
        let draggedCardIndex = null;
        let draggedOriginalIndex = null;
        
        // Persistent card ordering variables
        let localCardOrder = [];
        let pendingReorder = false;
        
        function addMessage(text) {
            const messages = document.getElementById('messages');
            if (messages) {
                const div = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                safeSetText(div, `${timestamp}: ${text}`);
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }
            console.log("Message: " + text);
        }
        
        function testSocket() {
            addMessage("Connecting to server...");
            
            if (socket) {
                socket.disconnect();
            }
            
            try {
                // Secure Socket.IO connection
                socket = io({
                    transports: ['websocket', 'polling'],
                    timeout: 5000,
                    forceNew: true,
                    autoConnect: true,
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000
                });
                
                socket.on('connect', () => {
                    addMessage("✅ Connected to server!");
                    safeSetText(document.getElementById('connectionStatus'), "Status: Connected");
                    const joinBtn = document.getElementById('joinBtn');
                    if (joinBtn) joinBtn.disabled = false;
                });
                
                socket.on('disconnect', () => {
                    addMessage("❌ Disconnected from server");
                    safeSetText(document.getElementById('connectionStatus'), "Status: Disconnected");
                    const joinBtn = document.getElementById('joinBtn');
                    if (joinBtn) joinBtn.disabled = true;
                });
                
                socket.on('playerJoined', (data) => {
                    if (!validateServerData(data, ['gameCode', 'players'])) {
                        addMessage("❌ Invalid server response");
                        return;
                    }
                    
                    addMessage("Player joined event received");
                    gameState.gameCode = sanitizeHTML(data.gameCode);
                    gameState.players = data.players.map(p => sanitizeHTML(p));
                    
                    safeSetText(document.
